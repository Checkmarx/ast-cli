name: Nightly Integration Tests

on:
  schedule:
    - cron: '30 21 * * *'  # Run daily at 3:00 AM IST (21:30 UTC)
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - feature/nightly-integration-tests  # TODO: Remove after testing

concurrency:
  group: nightly-integration-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION_FILE: go.mod
  COVERAGE_THRESHOLD: 75

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours max for long-running integration tests
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout the repository
        uses: actions/checkout@1e31de5234b9f8995739874a8ce0492dc87873e2 #v4.0.0
        with:
          ref: main

      - name: Set up Go version
        uses: actions/setup-go@4d34df0c2316fe8122ab82dc22947d607c0c91f9 #v4
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true

      - name: Display Go version
        run: go version

      - name: Go Build
        run: go build -o ./bin/cx ./cmd

      - name: Install gocovmerge
        run: go install github.com/wadey/gocovmerge@latest

      - name: Install pre-commit
        run: |
          pip install pre-commit
          pre-commit install

      - name: Run Integration Tests
        id: integration-test
        shell: bash
        env:
          CX_BASE_URI: ${{ secrets.CX_BASE_URI }}
          CX_CLIENT_ID: ${{ secrets.CX_CLIENT_ID }}
          CX_CLIENT_SECRET: ${{ secrets.CX_CLIENT_SECRET }}
          CX_BASE_AUTH_URI: ${{ secrets.CX_BASE_AUTH_URI }}
          CX_AST_USERNAME: ${{ secrets.CX_AST_USERNAME }}
          CX_AST_PASSWORD: ${{ secrets.CX_AST_PASSWORD }}
          CX_APIKEY: ${{ secrets.CX_APIKEY }}
          CX_TENANT: ${{ secrets.CX_TENANT }}
          CX_SCAN_SSH_KEY: ${{ secrets.CX_SCAN_SSH_KEY }}
          CX_ORIGIN: "cli-nightly-tests"
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PROXY_HOST: localhost
          PROXY_PORT: 3128
          PROXY_USERNAME: ${{ secrets.PROXY_USER }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
          PR_GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PR_GITHUB_NAMESPACE: "checkmarx"
          PR_GITHUB_REPO_NAME: "ast-cli"
          PR_GITHUB_NUMBER: 983
          PR_GITLAB_TOKEN: ${{ secrets.PR_GITLAB_TOKEN }}
          PR_GITLAB_NAMESPACE: ${{ secrets.PR_GITLAB_NAMESPACE }}
          PR_GITLAB_REPO_NAME: ${{ secrets.PR_GITLAB_REPO_NAME }}
          PR_GITLAB_PROJECT_ID: ${{ secrets.PR_GITLAB_PROJECT_ID }}
          PR_GITLAB_IID: ${{ secrets.PR_GITLAB_IID }}
          AZURE_ORG: ${{ secrets.AZURE_ORG }}
          AZURE_PROJECT: ${{ secrets.AZURE_PROJECT }}
          AZURE_REPOS: ${{ secrets.AZURE_REPOS }}
          AZURE_TOKEN: ${{ secrets.AZURE_TOKEN }}
          AZURE_PR_NUMBER: 1
          BITBUCKET_WORKSPACE: ${{ secrets.BITBUCKET_WORKSPACE }}
          BITBUCKET_REPOS: ${{ secrets.BITBUCKET_REPOS }}
          BITBUCKET_USERNAME: ${{ secrets.BITBUCKET_USERNAME }}
          BITBUCKET_PASSWORD: ${{ secrets.BITBUCKET_PASSWORD }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          PR_BITBUCKET_TOKEN: ${{ secrets.PR_BITBUCKET_TOKEN }}
          PR_BITBUCKET_NAMESPACE: "AstSystemTest"
          PR_BITBUCKET_REPO_NAME: "cliIntegrationTest"
          PR_BITBUCKET_ID: 1
        run: |
          chmod +x ./internal/commands/.scripts/integration_up.sh ./internal/commands/.scripts/integration_down.sh
          ./internal/commands/.scripts/integration_up.sh
          ./internal/commands/.scripts/integration_down.sh

      - name: Extract failed tests
        id: failed_tests
        if: always()
        shell: bash
        run: |
          if [ -f "failed_tests_summary.txt" ] && [ -s "failed_tests_summary.txt" ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            FAIL_COUNT=$(wc -l < failed_tests_summary.txt | tr -d ' ')
            echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
            # Format failed tests as bullet points for Teams
            FAILED_LIST=$(awk '{print "â€¢ " $0}' failed_tests_summary.txt | tr '\n' ',' | sed 's/,$//' | sed 's/,/\\n/g')
            echo "failed_list=$FAILED_LIST" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "fail_count=0" >> $GITHUB_OUTPUT
            echo "failed_list=" >> $GITHUB_OUTPUT
          fi

      - name: Send failure notification to Teams
        if: always() && steps.failed_tests.outputs.has_failures == 'true'
        uses: Skitionek/notify-microsoft-teams@v1.0.8
        with:
          webhook_url: ${{ secrets.MS_TEAMS_WEBHOOK_URL_SYPHER_INTEGRATION_TEST_CASE }}
          raw: >
            {
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.4",
                    "msteams": {
                      "width": "Full"
                    },
                    "body": [
                      {
                        "type": "TextBlock",
                        "text": "ðŸš¨ **Nightly Integration Tests Failed**",
                        "weight": "Bolder",
                        "size": "Large",
                        "color": "Attention"
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          { "title": "Repository:", "value": "${{ github.repository }}" },
                          { "title": "Branch:", "value": "main" },
                          { "title": "Run Number:", "value": "#${{ github.run_number }}" },
                          { "title": "Triggered By:", "value": "${{ github.event_name }}" },
                          { "title": "Failed Tests:", "value": "${{ steps.failed_tests.outputs.fail_count }}" }
                        ]
                      },
                      {
                        "type": "TextBlock",
                        "text": "**Failed Test Cases:**",
                        "weight": "Bolder",
                        "spacing": "Medium"
                      },
                      {
                        "type": "TextBlock",
                        "text": "${{ steps.failed_tests.outputs.failed_list }}",
                        "wrap": true,
                        "fontType": "Monospace",
                        "spacing": "Small"
                      }
                    ],
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "View Workflow Run",
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  }
                }
              ]
            }

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 #v4
        with:
          name: coverage-report-nightly-${{ github.run_number }}
          path: coverage.html
          retention-days: 30

      - name: Validate Code Coverage
        id: coverage-check
        shell: bash
        run: |
          CODE_COV=$(go tool cover -func cover.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "coverage=$CODE_COV" >> $GITHUB_OUTPUT
          echo "## Code Coverage: ${CODE_COV}%" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "$CODE_COV < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
            echo "::error::Code coverage ${CODE_COV}% is below threshold ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          else
            echo "::notice::Code coverage ${CODE_COV}% meets threshold ${{ env.COVERAGE_THRESHOLD }}%"
          fi
